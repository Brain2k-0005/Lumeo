@page "/patterns/kanban"
@namespace Lumeo.Docs.Pages.Patterns

<PageTitle>Kanban Board â€” Lumeo</PageTitle>

<PageHeader Title="Kanban Board" Description="A project board with task cards organized by status columns. Drag cards between columns to change status." />

<div class="w-full space-y-6">

    <!-- Top bar -->
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-foreground">Project Board</h2>
        <div class="flex items-center gap-3">
            <div class="relative">
                <Blazicon Svg="Lucide.Search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none" />
                <Input placeholder="Search tasks..." Class="pl-9 w-56" @bind-Value="_search" />
            </div>
            <Button>
                <Blazicon Svg="Lucide.Plus" class="h-4 w-4 mr-2" />
                New Task
            </Button>
        </div>
    </div>

    <!-- Kanban columns -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">

        <!-- To Do -->
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <h3 class="text-sm font-semibold text-foreground">To Do</h3>
                    <Badge Variant="Badge.BadgeVariant.Secondary">@_todoCards.Count</Badge>
                </div>
                <Button Variant="Button.ButtonVariant.Ghost" Size="Button.ButtonSize.Icon">
                    <Blazicon Svg="Lucide.Plus" class="h-4 w-4" />
                </Button>
            </div>
            <div class="space-y-3 min-h-[80px] rounded-lg p-1 transition-colors @(_dropTarget == "todo" ? "bg-primary/10 ring-2 ring-primary/30" : "")"
                 ondragover="event.preventDefault()"
                 @ondragover="() => _dropTarget = &quot;todo&quot;"
                 @ondragleave="() => _dropTarget = &quot;&quot;"
                 @ondrop="() => Drop(_todoCards)">
                @foreach (var card in _todoCards)
                {
                    <div draggable="true"
                         @ondragstart="() => DragStart(card, _todoCards)">
                        @RenderTaskCard(card)
                    </div>
                }
            </div>
        </div>

        <!-- In Progress -->
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <h3 class="text-sm font-semibold text-foreground">In Progress</h3>
                    <Badge Variant="Badge.BadgeVariant.Secondary">@_inProgressCards.Count</Badge>
                </div>
                <Button Variant="Button.ButtonVariant.Ghost" Size="Button.ButtonSize.Icon">
                    <Blazicon Svg="Lucide.Plus" class="h-4 w-4" />
                </Button>
            </div>
            <div class="space-y-3 min-h-[80px] rounded-lg p-1 transition-colors @(_dropTarget == "inprogress" ? "bg-primary/10 ring-2 ring-primary/30" : "")"
                 ondragover="event.preventDefault()"
                 @ondragover="() => _dropTarget = &quot;inprogress&quot;"
                 @ondragleave="() => _dropTarget = &quot;&quot;"
                 @ondrop="() => Drop(_inProgressCards)">
                @foreach (var card in _inProgressCards)
                {
                    <div draggable="true"
                         @ondragstart="() => DragStart(card, _inProgressCards)">
                        @RenderTaskCard(card)
                    </div>
                }
            </div>
        </div>

        <!-- Done -->
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <h3 class="text-sm font-semibold text-foreground">Done</h3>
                    <Badge Variant="Badge.BadgeVariant.Secondary">@_doneCards.Count</Badge>
                </div>
                <Button Variant="Button.ButtonVariant.Ghost" Size="Button.ButtonSize.Icon">
                    <Blazicon Svg="Lucide.Plus" class="h-4 w-4" />
                </Button>
            </div>
            <div class="space-y-3 min-h-[80px] rounded-lg p-1 transition-colors @(_dropTarget == "done" ? "bg-primary/10 ring-2 ring-primary/30" : "")"
                 ondragover="event.preventDefault()"
                 @ondragover="() => _dropTarget = &quot;done&quot;"
                 @ondragleave="() => _dropTarget = &quot;&quot;"
                 @ondrop="() => Drop(_doneCards)">
                @foreach (var card in _doneCards)
                {
                    <div draggable="true"
                         @ondragstart="() => DragStart(card, _doneCards)">
                        @RenderTaskCard(card)
                    </div>
                }
            </div>
        </div>

    </div>
</div>

@code {
    private string _search = "";
    private TaskCard? _draggedCard;
    private List<TaskCard>? _dragSource;
    private string _dropTarget = "";

    public record TaskCard(string Title, string Description, string Priority, string Assignee, string Initials, string DueDate);

    private readonly List<TaskCard> _todoCards = new()
    {
        new("Design system tokens", "Define and document all color, spacing, and typography tokens for the new design system.", "High", "Olivia Martin", "OM", "Mar 5"),
        new("Write onboarding copy", "Draft welcome emails and in-app onboarding messages for new users.", "Medium", "Liam Johnson", "LJ", "Mar 8"),
        new("API rate limiting", "Implement rate limiting middleware to protect public API endpoints from abuse.", "High", "Sofia Davis", "SD", "Mar 6"),
        new("Mobile responsive nav", "Refactor navigation component to be fully responsive on small screens.", "Low", "William Kim", "WK", "Mar 12"),
    };

    private readonly List<TaskCard> _inProgressCards = new()
    {
        new("Authentication flow", "Build complete sign-in, sign-up, and password reset flows using the new auth service.", "High", "Jackson Lee", "JL", "Mar 4"),
        new("Dashboard analytics", "Add real-time charts and metrics to the main dashboard overview page.", "Medium", "Isabella Nguyen", "IN", "Mar 7"),
        new("Component library docs", "Document all Lumeo components with usage examples, props, and accessibility notes.", "Low", "Olivia Martin", "OM", "Mar 10"),
    };

    private readonly List<TaskCard> _doneCards = new()
    {
        new("Project scaffolding", "Set up repository, CI/CD pipeline, and base project structure.", "Medium", "Liam Johnson", "LJ", "Feb 28"),
        new("Database schema", "Design and migrate initial database schema for users, projects, and tasks.", "High", "Sofia Davis", "SD", "Mar 1"),
    };

    private void DragStart(TaskCard card, List<TaskCard> source)
    {
        _draggedCard = card;
        _dragSource = source;
    }

    private void Drop(List<TaskCard> target)
    {
        _dropTarget = "";
        if (_draggedCard is null || _dragSource is null || _dragSource == target) return;
        _dragSource.Remove(_draggedCard);
        target.Add(_draggedCard);
        _draggedCard = null;
        _dragSource = null;
    }

    private RenderFragment RenderTaskCard(TaskCard card) => __builder =>
    {
        var priorityVariant = card.Priority switch
        {
            "High" => Badge.BadgeVariant.Destructive,
            "Medium" => Badge.BadgeVariant.Secondary,
            _ => Badge.BadgeVariant.Outline
        };

        <Card Class="cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow">
            <CardContent Class="p-4 space-y-3">
                <div class="flex items-start justify-between gap-2">
                    <p class="text-sm font-medium text-foreground leading-snug">@card.Title</p>
                    <Badge Variant="@priorityVariant" Class="shrink-0 text-xs">@card.Priority</Badge>
                </div>
                <p class="text-xs text-muted-foreground">@card.Description</p>
                <Separator />
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="h-6 w-6 rounded-full bg-primary flex items-center justify-center text-primary-foreground text-xs font-semibold shrink-0">
                            @card.Initials
                        </div>
                        <span class="text-xs text-muted-foreground">@card.Assignee</span>
                    </div>
                    <div class="flex items-center gap-1 text-xs text-muted-foreground">
                        <Blazicon Svg="Lucide.Eye" class="h-3 w-3" />
                        @card.DueDate
                    </div>
                </div>
            </CardContent>
        </Card>
    };
}
