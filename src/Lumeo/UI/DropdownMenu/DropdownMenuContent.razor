@namespace Lumeo
@implements IAsyncDisposable

@if (Context.IsOpen)
{
    <div id="@_contentId" class="@CssClass" @onkeydown="HandleKeyDown" tabindex="-1" @attributes="AdditionalAttributes">
        @ChildContent
    </div>
}

@inject ComponentInteropService Interop

@code {
    [CascadingParameter] public DropdownMenu.DropdownMenuContext Context { get; set; } = default!;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public DropdownMenuAlign Align { get; set; } = DropdownMenuAlign.Start;
    [Parameter] public string? Class { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private readonly string _contentId = $"dropdown-content-{Guid.NewGuid():N}";
    private bool _registered;

    private string CssClass => $"fixed z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-fade-in {Class}".Trim();

    private string AlignStr => Align switch
    {
        DropdownMenuAlign.Start => "start",
        DropdownMenuAlign.Center => "center",
        DropdownMenuAlign.End => "end",
        _ => "start"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Context.IsOpen && !_registered)
        {
            await Interop.PositionFixed(_contentId, Context.WrapperId, AlignStr);
            await Interop.RegisterClickOutside(_contentId, null, async () =>
            {
                await Context.SetOpen.InvokeAsync(false);
                await InvokeAsync(StateHasChanged);
            });
            _registered = true;
        }
        else if (!Context.IsOpen && _registered)
        {
            await Cleanup();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await Context.SetOpen.InvokeAsync(false);
        }
    }

    private async Task Cleanup()
    {
        try
        {
            await Interop.UnregisterClickOutside(_contentId);
        }
        catch (JSDisconnectedException) { }
        _registered = false;
    }

    public async ValueTask DisposeAsync()
    {
        if (_registered) await Cleanup();
    }

    public enum DropdownMenuAlign { Start, Center, End }
}
