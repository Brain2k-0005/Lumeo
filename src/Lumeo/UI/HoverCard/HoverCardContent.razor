@namespace Lumeo

@if (Context.IsOpen)
{
    <div id="@_contentId" class="@CssClass" @onmouseenter="() => Context.RequestOpen.InvokeAsync()" @onmouseleave="() => Context.RequestClose.InvokeAsync()" @attributes="AdditionalAttributes">
        @ChildContent
    </div>
}

@inject ComponentInteropService Interop

@code {
    [CascadingParameter] public HoverCard.HoverCardContext Context { get; set; } = default!;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public HoverCardAlign Align { get; set; } = HoverCardAlign.Center;
    [Parameter] public string? Class { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private readonly string _contentId = $"hovercard-content-{Guid.NewGuid():N}";
    private bool _positioned;

    private string CssClass => $"fixed z-50 w-64 rounded-md border border-border bg-popover p-4 text-popover-foreground shadow-lg outline-none animate-fade-in {Class}".Trim();

    private string AlignStr => Align switch
    {
        HoverCardAlign.Start => "start",
        HoverCardAlign.Center => "center",
        HoverCardAlign.End => "end",
        _ => "center"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Context.IsOpen && !_positioned)
        {
            await Interop.PositionFixed(_contentId, Context.WrapperId, AlignStr);
            _positioned = true;
        }
        else if (!Context.IsOpen && _positioned)
        {
            _positioned = false;
        }
    }

    public enum HoverCardAlign { Start, Center, End }
}
