@inject IJSRuntime JS

<div class="rounded-xl border border-border bg-card overflow-hidden">
    @* Header bar with title and tab switcher *@
    <div class="flex items-center justify-between border-b border-border px-4 py-3 bg-muted/20">
        <div class="flex items-center gap-1 rounded-md border border-border bg-background p-0.5">
            <button class="@TabButtonClass(true)" @onclick="ShowPreview">
                <DynamicIcon Name="Eye" Class="h-3.5 w-3.5 mr-1.5" />
                Preview
            </button>
            <button class="@TabButtonClass(false)" @onclick="ShowCode">
                <DynamicIcon Name="Code" Class="h-3.5 w-3.5 mr-1.5" />
                Code
            </button>
        </div>
        <div class="flex items-center gap-2">
            @if (Title != null)
            {
                <span class="text-xs text-muted-foreground font-medium hidden sm:inline">@Title</span>
            }
        </div>
    </div>

    @* Preview panel *@
    @if (_activeTab == Tab.Preview)
    {
        <div class="flex items-center justify-center min-h-[160px] p-8 bg-muted/20">
            <div class="flex items-center justify-center w-full">
                @ChildContent
            </div>
        </div>
    }

    @* Code panel *@
    @if (_activeTab == Tab.Code && Code != null)
    {
        <div class="relative">
            <div class="code-block !rounded-none !border-0 max-h-[420px] overflow-auto">@Code</div>
        </div>
    }

    @* Footer bar *@
    <div class="flex items-center justify-between border-t border-border px-4 py-2.5 bg-muted/20">
        @if (Description != null)
        {
            <p class="text-xs text-muted-foreground">@Description</p>
        }
        else
        {
            <span></span>
        }
        <div class="flex items-center gap-1.5">
            @if (Code != null)
            {
                <button class="inline-flex items-center gap-1.5 rounded-md px-2.5 py-1.5 text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors"
                        @onclick="CopyCode"
                        title="Copy code">
                    @if (_copied)
                    {
                        <DynamicIcon Name="Check" Class="h-3.5 w-3.5 text-primary" />
                        <span class="text-primary">Copied</span>
                    }
                    else
                    {
                        <DynamicIcon Name="Clipboard" Class="h-3.5 w-3.5" />
                        <span>Copy</span>
                    }
                </button>
                <button class="inline-flex items-center gap-1.5 rounded-md px-2.5 py-1.5 text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors"
                        @onclick="ToggleCode"
                        title="View source">
                    <DynamicIcon Name="Code" Class="h-3.5 w-3.5" />
                    <span>@(_activeTab == Tab.Code ? "Preview" : "Code")</span>
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Code { get; set; }
    [Parameter] public string? Description { get; set; }

    private enum Tab { Preview, Code }
    private Tab _activeTab = Tab.Preview;
    private bool _copied;

    private string TabButtonClass(bool isPreview)
    {
        var active = (isPreview && _activeTab == Tab.Preview) || (!isPreview && _activeTab == Tab.Code);
        return active
            ? "inline-flex items-center rounded px-3 py-1 text-xs font-medium bg-background shadow-sm text-foreground transition-all"
            : "inline-flex items-center rounded px-3 py-1 text-xs font-medium text-muted-foreground hover:text-foreground transition-all";
    }

    private void ShowPreview() => _activeTab = Tab.Preview;
    private void ShowCode() => _activeTab = Tab.Code;
    private void ToggleCode() => _activeTab = _activeTab == Tab.Code ? Tab.Preview : Tab.Code;

    private async Task CopyCode()
    {
        if (Code == null) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", Code);
        _copied = true;
        StateHasChanged();
        await Task.Delay(2000);
        _copied = false;
        StateHasChanged();
    }
}
